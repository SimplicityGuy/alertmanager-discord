---
# This workflow runs all code quality checks including linting, formatting, and type checking.
# It must pass before any other workflows (test, build) can run.
name: Code Quality

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
    paths:
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
      - "**/Dockerfile"
      - ".github/workflows/code-quality.yml"
      - ".pre-commit-config.yaml"
      - ".golangci.yml"
  pull_request:
    branches:
      - main
    paths:
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
      - "**/Dockerfile"
      - ".github/workflows/code-quality.yml"
      - ".pre-commit-config.yaml"
      - ".golangci.yml"

env:
  CI: true
  GO_VERSION: '1.20'

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ·ï¸ Set lowercase image name
        id: image
        run: |
          echo "IMAGE_NAME=$(echo "${{ github.repository }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ’¾ Cache pre-commit hooks
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pre-commit-

      - name: ðŸ§ª Run pre-commit hooks
        uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Pre-commit Metrics::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Pre-commit - ${{ env.IMAGE_NAME }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Code Quality (Pre-commit)
          webhook: ${{ secrets.DISCORD_WEBHOOK }}

  golangci-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ·ï¸ Set lowercase image name
        id: image
        run: |
          echo "IMAGE_NAME=$(echo "${{ github.repository }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: ðŸ’¾ Cache golangci-lint
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/golangci-lint
            ~/.cache/go-build
          key: ${{ runner.os }}-golangci-lint-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-golangci-lint-

      - name: ðŸ§ª Run golangci-lint
        uses: golangci/golangci-lint-action@971e284b6050e8a5849b72094c50ab08da042db8 # v6.1.1
        with:
          version: latest
          args: --timeout=5m

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Golangci-lint Metrics::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Golangci-lint - ${{ env.IMAGE_NAME }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Code Quality (Go Linting)
            Go Version: ${{ env.GO_VERSION }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}

  go-fmt:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ§ª Check Go formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "âŒ Go code is not formatted. Please run: gofmt -w ."
            gofmt -d .
            exit 1
          fi
          echo "âœ… Go code is properly formatted"

      - name: ðŸ§ª Run go vet
        run: go vet ./...

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Go Format Metrics::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Go Format Check - ${{ github.event.repository.name }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Code Quality (Go Formatting & Vet)
            Go Version: ${{ env.GO_VERSION }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
