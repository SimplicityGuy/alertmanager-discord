---
name: Docker Validate

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "**/Dockerfile"
      - ".dockerignore"
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
      - ".github/workflows/docker-validate.yml"
  pull_request:
    branches:
      - main
    paths:
      - "**/Dockerfile"
      - ".dockerignore"
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
      - ".github/workflows/docker-validate.yml"

concurrency:
  group: docker-validate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  GO_VERSION: '1.20'

permissions:
  contents: read

jobs:
  validate-dockerfile:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ·ï¸ Set lowercase image name
        id: image
        run: |
          echo "IMAGE_NAME=$(echo "${{ github.repository }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ” Validate Dockerfile with hadolint
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error
          ignore: DL3018  # Pinning versions in apk is impractical for Alpine packages

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Hadolint Metrics::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Dockerfile Validation - ${{ env.IMAGE_NAME }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Docker Validate (Hadolint)
          webhook: ${{ secrets.DISCORD_WEBHOOK }}

  test-docker-build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        stage: [builder, final]

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ·ï¸ Set lowercase image name
        id: image
        run: |
          echo "IMAGE_NAME=$(echo "${{ github.repository }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Test Docker build - ${{ matrix.stage }} stage
        id: build
        run: |
          echo "ðŸ”¨ Testing build for ${{ matrix.stage }} stage..."

          if [ "${{ matrix.stage }}" = "final" ]; then
            # Build the complete multi-stage image
            BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            docker buildx build \
              --build-arg GO_VERSION=${{ env.GO_VERSION }} \
              --build-arg BUILD_DATE="$BUILD_DATE" \
              --build-arg BUILD_VERSION=test \
              --build-arg VCS_REF=${{ github.sha }} \
              --load \
              -t ${{ env.IMAGE_NAME }}:test \
              .
            echo "âœ… Final stage built successfully"

            # Test the built image
            echo "ðŸ§ª Testing built image..."
            docker run --rm ${{ env.IMAGE_NAME }}:test -healthcheck || true
            echo "âœ… Image health check passed"
          else
            # Build only the builder stage
            docker buildx build \
              --build-arg GO_VERSION=${{ env.GO_VERSION }} \
              --target builder \
              --load \
              -t ${{ env.IMAGE_NAME }}:builder-test \
              .
            echo "âœ… Builder stage built successfully"
          fi

      - name: ðŸ” Inspect image metadata
        if: matrix.stage == 'final'
        run: |
          echo "ðŸ“Š Image labels:"
          docker inspect ${{ env.IMAGE_NAME }}:test | jq '.[0].Config.Labels'

          echo "ðŸ“Š Image size:"
          docker images ${{ env.IMAGE_NAME }}:test --format "{{.Size}}"

          echo "ðŸ“Š Image layers:"
          docker history ${{ env.IMAGE_NAME }}:test --no-trunc

      - name: ðŸ›¡ï¸ Check security best practices
        if: matrix.stage == 'final'
        run: |
          echo "ðŸ” Checking for non-root user..."
          user=$(docker inspect ${{ env.IMAGE_NAME }}:test | jq -r '.[0].Config.User')
          if [ "$user" != "notifier" ]; then
            echo "âŒ Container should run as 'notifier' user, found: $user"
            exit 1
          fi
          echo "âœ… Container runs as non-root user: $user"

          echo "ðŸ” Checking for health check..."
          healthcheck=$(docker inspect ${{ env.IMAGE_NAME }}:test | jq -r '.[0].Config.Healthcheck')
          if [ "$healthcheck" = "null" ]; then
            echo "âŒ Container should have a health check configured"
            exit 1
          fi
          echo "âœ… Health check is configured"

          echo "ðŸ” Checking exposed ports..."
          ports=$(docker inspect ${{ env.IMAGE_NAME }}:test | jq -r '.[0].Config.ExposedPorts | keys[]')
          if [ "$ports" != "9094/tcp" ]; then
            echo "âŒ Container should expose port 9094/tcp, found: $ports"
            exit 1
          fi
          echo "âœ… Correct port exposed: $ports"

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Docker Build Metrics (${{ matrix.stage }})::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Docker Build Test - ${{ matrix.stage }} - ${{ env.IMAGE_NAME }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Docker Validate (Build Test)
            Stage: ${{ matrix.stage }}
            Go Version: ${{ env.GO_VERSION }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}

  validate-dockerignore:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ” Validate .dockerignore exists
        run: |
          if [ ! -f .dockerignore ]; then
            echo "âš ï¸ Warning: .dockerignore file not found"
            echo "Creating recommended .dockerignore..."
            cat > .dockerignore << 'EOF'
          # Git
          .git
          .gitignore
          .gitattributes

          # GitHub
          .github

          # Documentation
          *.md
          LICENSE

          # IDE
          .vscode
          .idea
          *.swp
          *.swo

          # CI/CD
          .pre-commit-config.yaml

          # Build artifacts
          alertmanager-discord
          alertmanager-discord.darwin
          alertmanager-discord.linux

          # Test files
          *_test.go
          EOF
            echo "âŒ Please add the .dockerignore file to your repository"
            exit 1
          fi
          echo "âœ… .dockerignore file exists"

      - name: ðŸ” Check for common exclusions
        run: |
          if ! grep -q "\.git" .dockerignore; then
            echo "âš ï¸ Warning: .dockerignore should exclude .git directory"
          fi

          if ! grep -q "\.github" .dockerignore; then
            echo "âš ï¸ Warning: .dockerignore should exclude .github directory"
          fi

          if ! grep -q "\*\.md" .dockerignore; then
            echo "âš ï¸ Warning: .dockerignore should exclude markdown files"
          fi

          echo "âœ… .dockerignore validation complete"

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Dockerignore Metrics::Duration: ${duration}s"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Dockerignore Validation - ${{ github.event.repository.name }}"
          description: |
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Workflow: Docker Validate (Dockerignore)
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
