---
name: Cleanup Docker Images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 15 * *"  # Monthly on the 15th at midnight UTC

concurrency:
  group: cleanup-images
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io

permissions:
  packages: write  # Required to delete packages
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      packages: write
      contents: read

    steps:
      - name: â±ï¸ Start timer
        id: timer
        run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: ðŸ·ï¸ Set repository variables
        id: vars
        run: |
          echo "OWNER=$(echo "${{ github.repository_owner }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"
          echo "PACKAGE=$(echo "${{ github.event.repository.name }}" | tr "[:upper:]" "[:lower:]")" >> "$GITHUB_ENV"
          echo "ðŸ“¦ Owner: ${{ github.repository_owner }}"
          echo "ðŸ“¦ Package: ${{ github.event.repository.name }}"
          echo "ðŸ“¦ Package URL: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}"

      - name: ðŸ” Validate package access
        id: validate
        continue-on-error: true
        run: |
          echo "ðŸ” Checking package access..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/user/packages/container/${PACKAGE}/versions")
          echo "response_code=${RESPONSE}" >> "$GITHUB_OUTPUT"
          if [ "${RESPONSE}" = "200" ]; then
            echo "âœ… Package access confirmed"
          else
            echo "âš ï¸ Package access returned HTTP ${RESPONSE}"
            echo "This might indicate the package doesn't exist or needs different permissions"
          fi

      - name: ðŸ§¹ Cleanup Docker images
        id: cleanup
        uses: dataaxiom/ghcr-cleanup-action@cd0cdb900b5dbf3a6f2cc869f0dbb0b8211f50c4 # v1.0.16
        with:
          package-type: container
          delete-partial-images: true
          delete-untagged: true
          keep-n-tagged: 3
          older-than: 30 days
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ env.OWNER }}
          package: ${{ env.PACKAGE }}
          log-level: info
          validate: true

      - name: ðŸ“Š Collect metrics
        if: always()
        id: metrics
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ steps.timer.outputs.start_time }}))
          echo "duration=${duration}" >> "$GITHUB_OUTPUT"
          echo "::notice title=Cleanup Metrics::Duration: ${duration}s, Package: ${{ env.PACKAGE }}"

      - name: ðŸ“¢ Send notification to Discord
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: always()
        with:
          title: "Docker Image Cleanup - ${{ env.PACKAGE }}"
          description: |
            Registry: ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.PACKAGE }}
            Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
            Validation: HTTP ${{ steps.validate.outputs.response_code || 'N/A' }}

            Settings:
            â€¢ Keep last 3 tagged images
            â€¢ Delete images older than 30 days
            â€¢ Delete untagged images
            â€¢ Delete partial images

            Status: ${{ job.status }}
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
